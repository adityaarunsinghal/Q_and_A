---
title: "exp3_analysis"
output: html_document
---

Set wd

```{r}
setwd("/Users/rxdh/Box Sync/stanford/research/goodman/q&a/experiment3/")
library(dplyr)
library(ggplot2)
```

First, import data

```{r}
# Restricted answer space (x is at gate y)
d_orig = read.csv("./versions/experiment3_orig/q_and_a3-trials.tsv", sep = '\t')
# Free response answer space
d1 = read.csv("../../experiment3_fr/data/q_and_a3_fr-trials.tsv", sep = '\t')
```

We begin by analyzing the 'question' part of the experiment. Extract the question items.

```{r}
d_orig_q = subset(d_orig, trial_type == 'question', select=c(workerid, qud, response))
d1_q = subset(d1, trial_type == 'question', select=c(workerid, qud, response))
d1_q$response = factor(d1_q$response)
pooled_qs = rbind(d_orig_q, d1_q)
str(pooled_qs)
```

Now, for a given qud, we want to know the distribution of questions asked (could be pooled with data from other versions, since this was the same in all). This part of the experiment was the same for the two versions, hence we pool them together.

```{r}
new_labels = sapply(X = pooled_qs$qud, FUN = function(v) {return(paste("qud:", v))})
pooled_qs$facet_label = new_labels
g4<-ggplot(pooled_qs, aes(x=response)) + geom_histogram(color="black", fill='black')
g4 + facet_wrap(~qud)
```

Next, we evaluate the answers:

Note that participants always tell the truth -- the gate they give always matches the true location of the item they give.

```{r}
d_orig_a = subset(d_orig, trial_type == 'ans:', 
              select=c(workerid, utterance, world_state, gate_response, item_response))
d_orig_a$world_state = strsplit(as.character(d_orig_a$world_state), split = ',')
for(i in 1:dim(d_orig_a)[1]){
  d_orig_a$telling_truth = d_orig_a$gate_response[i] == match(tolower(d_orig_a$item_response[i]), 
                                                      d_orig_a$world_state[i][[1]])
}
```

This justifies just looking at the item they give:

```{r}
new_labels = sapply(X = d_orig_a$utterance, FUN = function(v) {return(paste("utterance:", v))})
d_orig_a$facet_label = new_labels
g4<-ggplot(d_orig_a, aes(x=item_response)) + geom_histogram(color="black", fill='black')
g4 + facet_wrap(~facet_label)
```

Now, for the harder to parse data:

```{r}
d1_a = subset(d1, trial_type == 'ans:', 
              select=c(workerid, utterance, world_state, response))
d1_a$world_state = strsplit(as.character(d1_a$world_state), split = ',')
for(i in 1:dim(d1_a)[1]){
  # 1. Extract numbers from unstructured text
  raw_response <- as.character(d1_a$response[i])
  gr <- as.character(gsub("[^0-9]", "", unlist(raw_response)))
  d1_a$gate_response[i] = gr
  # 2. Figure out which item was behind this gate 
  if(nchar(gr) == 1) {
    item_response <- d1_a$world_state[i][[1]][as.numeric(gr)] 
  } else {
    item_response <- paste("mult: ", as.character(d1_a$utterance[i]))
  } 
  d1_a$item_response[i] = item_response
}
d1_a$item_response
```

Now plot these answers... Note that we collapsed together a participant giving multiple gates (e.g. "a thing is behind gates 1,2,3,and 4")

```{r}
new_labels = sapply(X = d1_a$utterance, FUN = function(v) {return(paste("utterance:", v))})
d1_a$facet_label = new_labels
g4<-(ggplot(d1_a, aes(x=item_response)) 
     + geom_histogram(color="black", na.rm = T, fill='black')
     + facet_wrap(~facet_label) 
     + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)))
g4
```

Most of the multiple responses appear in 'dog' and 'animal'. 

Otherwise, it's pretty cool that even for vague questions like 'where is a thing?' almost everyone gave the exact location of the flower (without even specifying *what* is behind that gate). Just "which gate has a thing behind it?" -> "gate 3". A bit curious whether 'thing' became a label for the flower, or whether they reasoned it out in full... 

If you take out the multiple gate references, this is the same result as the non-free form version. 

Experiment3_short analysis
--------------------------

Load and clean data. We remove people who self-identify as 'confused' 

```{r}
d_short = read.csv("versions/experiment3_short/data/q_and_a3_short-trials.tsv",  sep = '\t')
# Remove people who were confused...
ps=read.csv("versions/experiment3_short/data/q_and_a3_short-subject_information.tsv", 
              sep = '\t')
nonconfused_ps <- (ps %>% 
                   mutate(asses2 = ifelse(is.na(asses), "None", asses)) %>% 
                   filter(asses2 != 1))$workerid
d_short = filter(d_short, workerid %in% nonconfused_ps)
```

Run questioner 

```{r}
d_short_q = subset(d_short, trial_type == 'question', 
                   select=c(workerid, qud, response))
# Order responses and facets
d_short_q$response = ordered(d_short_q$response, 
                             levels = c("dalmatian", "dog", "mammal", "animal"))
d_short_q$facet_label = (sapply(X = d_short_q$qud, 
                                FUN = function(v) {return(paste("qud:", v))}) %>% 
                         ordered(levels = c("qud: dalmatian", "qud: poodle", 
                                            "qud: siamese cat", "qud: goldfish")))
jpeg(filename="../writing/2015/cogsci/exp3_q.jpeg")
g4<-(ggplot(d_short_q, aes(x=response)) 
    + theme_bw(base_size = 20)
    + theme(axis.text.x = element_text(angle=90, vjust=1))
    + geom_histogram(color="black", fill='black')
    + ggtitle("(a) Questioner responses")
    + facet_wrap(~facet_label))
g4
dev.off()
```

Answer analysis

```{r}
d_short_a = subset(d_short, trial_type == 'ans:', 
                   select=c(workerid, utterance, world_state, response))
# Remove one trial where someone forgot to respond and somehow got through...
d_short_a <- d_short_a[d_short_a$response != "None",]
d_short_a$response = as.numeric(d_short_a$response)
# Map gate number responses onto the objects at those gates on the given trial
d_short_a$world_state = strsplit(as.character(d_short_a$world_state), split = ',')
for(i in 1:dim(d_short_a)[1])
  d_short_a$item_response[i] = d_short_a$world_state[[i]][d_short_a$response[i]]
# Order response
d_short_a$response = ordered(d_short_a$item_response,
                             levels=c("dalmatian","poodle","siamese cat","goldfish"))
# Make nicer labels for facets
new_labels = as.factor(sapply(X = d_short_a$utterance, 
                       FUN = function(v) {return(paste("utterance:", v))}))
# Order facets by level in hierarchy
d_short_a$facet_label = ordered(new_labels, 
                                levels = c("utterance: dalmatian", "utterance: dog", 
                                           "utterance: mammal","utterance: animal"))
jpeg(filename="../writing/2015/cogsci/exp3_ans.jpeg")
g4<-(ggplot(d_short_a, aes(x=response)) 
     + geom_histogram(color="black", fill='black')
     + theme_bw(base_size = 20)
     + theme(axis.text.x = element_text(angle=90, vjust=1))
     + ggtitle("(b) Answerer responses")
     + facet_wrap(~facet_label))
g4
dev.off()
```

Model prediction plots
----------------------

Plot for question model predictions

```{r}
pred_q = read.csv("analysis/model_prediction/questionerModelPredictions.txt", sep = '\t')
pred_q$response = ordered(pred_q$response, 
                          levels = c("dalmatian", "dog","mammal", "animal"))
new_labels = sapply(X = pred_q$qud, FUN = function(v) {return(paste("qud:", v))})
pred_q$facet_label = ordered(new_labels,
                             levels = c("qud: dalmatian", "qud: poodle", 
                                        "qud: siamese", "qud: goldfish"))
# This is obviously misleading -- but for now I just want to show the ORDERING
pred_q$prob <- pred_q$prob - .22
jpeg(filename="../writing/2015/cogsci/Exp3QuestionerPrediction.jpeg")
g4<-(ggplot(pred_q, aes(x=response, y=prob)) 
    #+ scale_y_continuous(limits = c(0,.3))
    + geom_bar(stat='identity', color='black', fill='black')
    + theme_bw(base_size = 20)
    + theme(axis.text.x = element_text(angle=90, vjust=1))
    + ggtitle("(a) Questioner Model Predictions")
    + facet_wrap(~facet_label))
g4
dev.off()
```

Now, plot for dumb model:

```{r}
pred_ll = read.csv("analysis/model_prediction/litListenerModelPredictions.csv", sep = '\t')
pred_ll$response = ordered(pred_ll$response, levels = c("dalmatian", "poodle", "siamese", "goldfish"))
new_labels = as.factor(sapply(X = pred_ll$utterance, FUN = function(v) {return(paste("utterance:", v))}))
pred_ll$facet_label = ordered(new_labels, 
                              levels = c("utterance: dalmatian", "utterance: dog", 
                                         "utterance: mammal","utterance: animal"))
jpeg(filename="../writing/2015/cogsci/Exp3ExplicitAnswerPrediction.jpeg")
g4<-(ggplot(pred_ll, aes(x=response, y = prob)) 
     + geom_histogram(stat='identity', color="black", fill='black')
     + theme_bw(base_size = 20)
     + theme(axis.text.x = element_text(angle=90, vjust=1))
     + ggtitle("(b) Explicit Answer Model Predictions")
     + facet_wrap(~facet_label))
g4
dev.off()
```

Plot for pragmatic model

```{r}
pred_prag = read.csv("analysis/model_prediction/pragAnswererModelPredictions.csv", sep = '\t')
pred_prag$response = ordered(pred_prag$response, 
                           levels = c("dalmatian", "poodle", "siamese", "goldfish"))
new_labels = sapply(X = pred_prag$utterance, FUN = function(v) {return(paste("utterance:", v))})
pred_prag$facet_label = ordered(new_labels, 
                              levels = c("utterance: dalmatian", "utterance: dog", 
                                         "utterance: mammal","utterance: animal"))
jpeg(filename="../writing/2015/cogsci/Exp3PragmaticAnswerPrediction.jpeg")
g4<-(ggplot(pred_prag, aes(x=response, y=prob)) 
    + geom_bar(stat='identity', color='black', fill='black')
    + theme_bw(base_size = 20)
    + theme(axis.text.x = element_text(angle=90, vjust=1))
    + ggtitle("(c) Pragmatic Answer Model Predictions")
    + facet_wrap(~facet_label))
g4
dev.off()
```

Fitting rationality parameters
------------------------------

```{r}
pred_q = read.csv("analysis/model_prediction/questionerRationalityFitting.csv", sep = ',')
by_qud_resp <- tbl_df(d_short_q) %>% group_by(qud, response)
res <- by_qud_resp %>% summarise( prob = n() / 23)
expanded_res <- left_join(expand.grid(response = levels(d_short_q$response), qud = levels(d_short_q$qud)),res)
expanded_res[is.na(expanded_res)] <- 0
#pred_q$response = ordered(pred_q$response, 
#                          levels = c("dalmatian", "dog","mammal", "animal"))
#new_labels = sapply(X = pred_q$qud, FUN = function(v) {return(paste("qud:", v))})
#pred_q$facet_label = ordered(new_labels,
#                             levels = c("qud: dalmatian", "qud: poodle", 
#                                        "qud: siamese", "qud: goldfish"))
# This is obviously misleading -- but for now I just want to show the ORDERING
#pred_q$prob <- pred_q$prob - .22
jpeg(filename="../writing/2015/cogsci/QuestionerRationalityTuning.jpeg")

for(i in 1:length(pred_q$prob)) {
  true_prob = subset(expanded_res, 
                     response == pred_q$response[i] 
                     & qud == pred_q$qud[i])$prob
  pred_q$prob_diff[i] = summarise(abs(pred_q$prob[i] - true_prob)
}

mean_diff_pred <- pred_q %>% 
  group_by(ansR, KLR) %>% 
  summarise(ss_diff = sum(prob_diff^2))
mean_diff_pred[which.min(mean_diff_pred$ss_diff),]
g4 <- (ggplot(mean_diff_pred, aes(x = ansR, y =KLR))
       + geom_tile(aes(fill = ss_diff))
       + scale_fill_gradient(low = "white", high = "black"))
g4
# qud = "goldfish"
# g4<-(ggplot(subset(pred_q, qud == qud), aes(x=ansR, y=KLR)) 
#     + geom_tile(aes(fill = prob_diff))
#     + scale_fill_gradient(low = "white", high = "black")    
#     + facet_wrap(~response, scales="free"))
# g4
```

